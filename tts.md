TTS 方案设计（草案 v2.1）

目标
- 后端在启动时自动“检查并下载一次”固定短句的音频资源（通过 edge-tts 在线合成），生成结果缓存到前端静态目录供前端直接播放（默认始终启用，无需开关）。
- 提供一个只读 API 给前端查询“音频资源是否准备就绪（ready/preparing/failed）”。运行期不提供手动刷新入口。

范围与前提
- 仅面向“固定短句”列表（不是任意文本实时 TTS）。
- 使用 edge-tts CLI（Python 工具）进行在线合成；首次生成需要可用的外网。
- 若 CLI 或网络不可用，后端不得阻塞服务启动；应记录日志并上报状态给前端（best-effort）。

术语
- 短句清单：固定短句列表文件（每行一句，`#` 开头为注释）。
- 资源目录：前端静态目录下的 `audio/tts`，用于存放生成的音频和清单。
- 清单文件：`manifest.json`，结构 `[{"text":"...","file":"<sha1>.mp3"}, ...]`。


环境变量（backend/.env）
- TTS_PHRASES_FILE: 短句清单文件（默认 `backend/tts/phrases.txt`）
- TTS_OUTPUT_DIR: 输出目录（默认 `frontend/public/audio/tts`）
- TTS_VOICE: 语音名称（默认 `zh-CN-XiaoxiaoNeural`）
- TTS_PITCH: 可选，默认空（示例 `+0Hz`）
- TTS_RATE: 可选，默认空（示例 `+0%`）
- TTS_CONCURRENCY: 并发生成数（默认 1，保守）
- TTS_TIMEOUT_SECS: 单条短句合成超时（默认 60）

文件与命名
- 产物命名：`<sha1(text)>.mp3`（小写十六进制）
- 产物目录：`<TTS_OUTPUT_DIR>/`
- 清单：`<TTS_OUTPUT_DIR>/manifest.json`


工具说明（简化）
- edge-tts 是通过 pip 安装的 Python CLI（入口脚本名 `edge-tts`）。
- 后端直接调用 PATH 中的 `edge-tts`。

启动期生成流程（后端实现）
1) 在进程启动阶段执行“一次性检查与生成”（best-effort，不阻塞服务），读取 env 获取路径等配置。
2) 校验短句清单是否存在，不存在则 `warn` 并跳过（状态为 disabled 或 missing_phrases）。
3) 校验输出目录，创建不存在的目录。
4) 预检 TTS 工具可用性（可执行 + 快速 `--help` 成功）；失败：
   - 记录 `warn`，生成状态 `toolUnavailable=true`，`ready=false`，不阻塞启动。
5) 读取清单，计算每条短句的目标文件名，收集缺失列表。
6) 若缺失数为 0：写入 `manifest.json`（与清单同步），并将内存状态更新为 ready（missing=0，updatedAt）。
7) 若存在缺失：
   - 按 `TTS_CONCURRENCY` 控制并发调用 CLI：`edge-tts --voice VOICE --text TEXT --write-media FILE [--pitch X] [--rate Y]`
   - 为每条任务设定 `TTS_TIMEOUT_SECS` 超时；失败项按“最多 3 次重试”策略执行（见下文），仍失败则记录并跳过。
   - 成功后更新计数；任务全部结束后重新生成 `manifest.json`。
   - 汇总更新内存状态：记录状态 ready/failed、missing 与 updatedAt（供 API 返回）。
8) 全流程不影响 HTTP 服务启动；只在日志与 API 中体现。该流程仅在启动时执行一次，运行期不自动重试、不轮询、无手动触发入口。

内存状态
- 保持一份内存快照（AppState）用于 API 快速返回：包括 status（ready/preparing/failed）、missing、updatedAt。
- 不在磁盘生成 status.json；排查问题直接查看服务日志。

API 设计
- GET `/api/tts/status`
  - 用途：前端用来展示“音频资源状态”。
  - 返回（最简）：
    { "status": "ready" | "preparing" | "failed" }
  - 判定规则：
    - ready：所需音频均已存在，或启动期一次性任务完成且无缺失。
    - preparing：仅在启动窗口内有效，表示一次性生成任务正在进行。
    - failed：工具不可用/无法执行，或一次性任务结束后仍有缺失且不再继续（需人工介入或等待下次重启再尝试）。
  - 备注：如需调试信息（例如缺失数量、错误摘要），可在开发模式下增加 `?verbose=1` 返回扩展字段，但默认仅返回 `status`。

短句规范与命名一致性
- 字符编码：短句文件与处理流程统一使用 UTF-8。
- 规范化规则（影响哈希与文件名，务必一处约定、处处一致）：
  - 去除整行首尾空白（trim）。
  - 跳过空行与以 `#` 开头的注释行。
  - 不改变大小写与标点，不做全角/半角转换（保持作者原意）。
  - 不进行内部空白折叠（即保留作者在短句中的空格设计）。
- 哈希与文件名：`sha1(规范化后文本的 UTF-8 字节)` → 小写十六进制，扩展名 `.mp3`。
- 说明：若使用任何辅助脚本（如历史上的 Python 预烘焙脚本），必须遵循相同的规范化与哈希规则，确保文件名一致可复用。

写入策略与完整性
- 原子写：先写入临时文件 `<sha1>.mp3.part`，写完并校验后原子重命名为 `<sha1>.mp3`，避免并发/崩溃导致半文件被前端读取。
- 成功判定：CLI 返回码为 0 且目标文件存在且文件大小 > 0（最小阈值可设定，例如 > 1KB 以过滤空文件）。
- 失败处理：删除 `.part` 残留；记录失败详情到日志与内存状态。

并发与任务控制
- 并发度：`TTS_CONCURRENCY`（默认 1）；大集时可 2–4，留意对端速率限制。
- 超时：`TTS_TIMEOUT_SECS`（默认 60）；单任务超时计作失败并可重试。
- 去重：短句去重处理（基于哈希）以避免重复任务。
- 幂等：多次重启均安全；已存在的文件一律跳过。运行期不存在手动刷新入口。

工具分发与发现（重申）
  
- 许可合规：若内置可执行体，需在 README/NOTICE 标注来源、版本、许可证与适用平台（例如 Linux x86_64）。

音频格式与参数
- 默认格式：mp3。可选增加 `TTS_FORMAT`（默认 `audio-24khz-48kbitrate-mono-mp3`）并映射到 CLI 的 `--format`。
- 默认音色：`TTS_VOICE=zh-CN-XiaoxiaoNeural`；如需多音色，后续再扩展清单与目录结构。

网络与代理
- edge-tts 依赖外网；如环境有代理，请确保本机访问走直连或配置 `NO_PROXY` 以免 502/超时。
- 遇到网络波动时，依赖“最多三次重试”策略；仍失败判定为 `failed`，不影响其他服务能力。

安全与健壮性
- 输入来源：短句文件由仓库维护，不接收用户输入，避免命令注入风险。
- 进程安全：通过 Rust 的 `Command` 直接传参，不经 shell；避免转义问题。
- 资源限制：建议限制短句长度（如 ≤ 200 字符）与总量（如 ≤ 数百条），超出则日志警告并跳过或拆分。

状态机细节（/api/tts/status 三态）
- preparing：
  - 启动后首次扫描到缺失，worker 正在运行；或上次失败后手动触发刷新且在进行中。
- ready：
  - 扫描无缺失；或 worker 完成且无剩余缺失。
- failed：
  - 工具不可用；或 worker 完成后仍有缺失且不会继续自动重试（需人工介入或后续手动触发）。
- 备注：worker 退出后不自动轮询二次；再次尝试由重启或 `POST /api/tts/refresh` 触发。

前端静态路径假设
- 输出目录应被后端静态服务托管为 `/audio/tts`（确认后端 ServeDir 指向 `frontend/public`）。
- 前端直接以 `/audio/tts/<sha1>.mp3` 引用；若需要映射文本与文件名，前端可读取 `manifest.json`（开发辅助，不影响状态 API 的简洁性）。

前端开关与交互（语音播报）
- 开关命名（建议）：
  - UI 文案："语音播报"
  - 存储键：`ttsEnabled`（localStorage）
- 默认值：关闭（尊重用户意愿与静音环境）。
- 行为流转（简化，不轮询）：
  1) 页面加载完成后，前端请求一次 `GET /api/tts/status` 并记录结果（内存变量即可）。
  2) 用户开启“语音播报”时，再次请求一次 `GET /api/tts/status`：
     - 若 `status=ready`：启用语音功能；可选异步拉取 `manifest.json` 做短句→文件映射缓存。
     - 若 `status=preparing` 或 `status=failed`：提示“语音资源尚未准备好/不可用”，不开启语音；不做进一步重试。
- 失败提示建议（本地化文案占位）：
  - 准备中："正在准备语音资源……"
  - 失败："语音资源不可用，请稍后重试或联系管理员。"
- 不进行任何自动轮询或后台重试；仅上述两次获取（页面加载一次、用户开启时一次）。
- 其他细节：
  - 回放实现优先使用 `<audio>` 元素，确保在移动端/受限环境兼容。
  - 遵守浏览器自动播放策略：首次播放前需要用户有交互（开启开关即可视为一次交互）。
  - 播放音量、静音与开关联动：开关关闭立即停止后续播放，已在播音频可选择淡出或立即停止（简单实现可直接停止）。

前端状态获取策略（简化版）
- 页面加载：fetch(`/api/tts/status`) 获取一次并保存在内存。
- 用户开启：再次 fetch(`/api/tts/status`)，若 ready 则开启；否则提示不可用，不再重试。
- 请求失败（网络/404）：视为 failed 并提示，不再重试。

- 可选：POST `/api/tts/refresh`（权限后续再定）
  - 用途：运维或 CI 调用，触发一次刷新任务。
  - 行为：立即返回 202；后台启动刷新协程；状态通过 `/api/tts/status` 查询。

前端交互建议
- 页面加载后调用 `/api/tts/status`：
  - 若 `ready==true`：继续正常流程。
  - 若 `ready==false` 且 `enabled==true && toolAvailable==true`：提示“正在准备音频”，可每 N 秒轮询一次状态。
  - 若 `toolAvailable==false`：提示“音频功能不可用（缺少 TTS 工具）”。

错误处理与容错
- 短句清单缺失：跳过刷新，`ready=false`，`missing=total`。
- CLI 不存在或无法执行：`toolAvailable=false`，`ready=false`。
- 单条短句生成失败：记录失败，不中断其他任务；最终 `ready` 取决于是否还有缺失。
- 网络超时/错误：按超时处理，允许重试（初版可不做自动重试）。

性能与并发
- 默认串行（并发=1），避免对服务端网络与对端限流造成压力。
- 可按环境提升为 2~4，但需注意对端速率限制与时延。

安全与部署
- 建议将 `edge-tts` 以内置形式放在仓库 `third_party/bin/edge-tts`，并在 README 标注来源与许可证；或在 CI/CD 中产出该二进制并入包（针对部署目标平台，例如 Linux x86_64）。
- 若不内置二进制，则在部署前通过 `pip install edge-tts` 安装，或在镜像里预装。
- `GET /api/tts/status` 为只读且无敏感信息，可默认开放；`POST /api/tts/refresh` 如实现，建议受限（同源、token 或仅内网）。

后续扩展（里程碑）
- 支持自定义音频格式（mp3/opus/wav）与其他后端，可在未来里程碑中评估是否开放配置。
- 支持多语言/多音色复合清单（清单分组或多套输出目录）。

落地清单（实施前确认）
1) 确认短句清单文件与内容（编码 UTF-8，行内不含引号）。
2) 确认输出目录与前端静态托管路径一致（`/audio/tts`）。
3) 确认是否需要并发与超时具体值（默认 1 并发、60s 超时）。
4) 确认 `/api/tts/status` 返回字段是否需要扩展（是否返回缺失条目列表）。
5) 决定工具分发策略：
   - A 内置二进制：目标平台（例 Linux x86_64）、来源与许可证说明、落库路径 `third_party/bin/edge-tts`
   - B 运行环境预装：文档化 `pip install edge-tts`，并在启动日志与 API 提示缺失

任务与重试策略
- 任务模型：后端启动时创建一个“一次性生成工作线程/协程”（简称 worker），扫描缺失并按并发度生成音频。
- 线程生命周期：
  - 正常完成：所有缺失均处理完（成功或失败）后退出；`/api/tts/status` 根据结果报告 ready/failed。
  - 工具不可用/无法执行：判定为 failed，worker 直接退出，不再重试；其他功能不受影响。
  - 任何情况下，worker 不阻塞 HTTP 服务。
- 重试细则（默认最多 3 次）：
  - 作用域：单条短句的生成任务。
  - 触发：CLI 非 0 退出、超时或 I/O 错误。
  - 退避：建议指数退避（如 1s、2s、4s），可加入少量随机抖动。
  - 终止：重试 3 次仍失败则放弃该短句，记录错误；worker 继续处理其他短句。
  - 汇总：若最终仍有缺失，`/api/tts/status` 返回 `{"status":"failed"}`。
